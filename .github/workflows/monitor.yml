name: BYMA Cauciones Monitor

on:
  schedule:
    - cron: "30-59/5 13 * * 1-5"   # 13:30–13:55 UTC  (10:30–10:55 AR)
    - cron: "*/5 14-19 * * 1-5"    # 14:00–19:55 UTC  (11:00–16:55 AR)
    - cron: "0 20 * * 1-5"         # 20:00 UTC        (17:00 AR)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 1 Primero procesa comandos de Telegram (puede actualizar thresholds.json / fees.json y state.json)
      - name: Run bot commands
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          BYMA_VERIFY_SSL: "false"
        run: |
          python -u bot_commands.py

      # 2 Después corre el monitor de alertas
      - name: Run monitor
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          BYMA_VERIFY_SSL: "false"
        run: |
          python -u monitor.py

      # 3 Persiste cambios (offset del bot, state anti-spam, thresholds, fees)
      - name: Commit files if changed
        run: |
          if git diff --quiet; then
            echo "No changes"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add state_actions.json thresholds.json fees.json
            git commit -m "Update bot state/config"
            git pull --rebase
            git push
          fi
